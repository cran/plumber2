<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Upgrading From Plumber</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
width: 0.8em;
margin: 0 0.8em 0.2em -1em;  vertical-align: middle;
}
.display.math{display: block; text-align: center; margin: 0.5rem auto;}
</style>




<style type="text/css">body {background-color: #fff;margin: 1em auto;max-width: 700px;overflow: visible;padding-left: 2em;padding-right: 2em;font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;font-size: 14px;line-height: 1.35;}table {margin: 1em auto;border-width: 1px;border-color: #DDDDDD;border-style: outset;border-collapse: collapse;}table th {border-width: 2px;padding: 5px;border-style: inset;}table td {border-width: 1px;border-style: inset;line-height: 18px;padding: 5px 5px;}table, table th, table td {border-left-style: none;border-right-style: none;}table thead, table tr.even {background-color: #f7f7f7;}p {margin: 0.5em 0;}blockquote {background-color: #f6f6f6;padding: 0.25em 0.75em;}hr {border-style: solid;border: none;border-top: 1px solid #777;margin: 28px 0;}dl {margin-left: 0;}dl dd {margin-bottom: 13px;margin-left: 13px;}dl dt {font-weight: bold;}ul {margin-top: 0;}ul li {list-style: circle outside;}ul ul {margin-bottom: 0;}pre, code {background-color: #f7f7f7;border-radius: 3px;color: #333;white-space: pre-wrap; }pre {border-radius: 3px;margin: 5px 0px 10px 0px;padding: 10px;}pre:not([class]) {background-color: #f7f7f7;}code {font-family: Consolas, Monaco, 'Courier New', monospace;font-size: 85%;}p > code, li > code {padding: 2px 0px;}div.figure {text-align: center;}img {background-color: #FFFFFF;padding: 2px;border: 1px solid #DDDDDD;border-radius: 3px;border: 1px solid #CCCCCC;margin: 0 5px;}h1 {margin-top: 0;font-size: 35px;line-height: 40px;}h2 {border-bottom: 4px solid #f7f7f7;padding-top: 10px;padding-bottom: 2px;font-size: 145%;}h3 {border-bottom: 2px solid #f7f7f7;padding-top: 10px;font-size: 120%;}h4 {border-bottom: 1px solid #f7f7f7;margin-left: 8px;font-size: 105%;}h5, h6 {border-bottom: 1px solid #ccc;font-size: 105%;}a {color: #0033dd;text-decoration: none;}a:hover {color: #6666ff; }a:visited {color: #800080; }a:visited:hover {color: #BB00BB; }a[href^="http:"] {text-decoration: underline; }a[href^="https:"] {text-decoration: underline; }</style>
</head>

<body>


<header id="title-block-header">
<h1 class="title">Upgrading From Plumber</h1>

</header>


<h2 id="moving-from-plumber">Moving from plumber</h2>
<p>Plumber2 is designed in a way that should make it very familiar to long-time plumber users. However, it has been created with the explicit intend to not be API-compatible with old plumber code and plumber files, except in the simplest of cases. We have done this to allow us to learn from many years of experience with plumber and keep what work while shedding what has proven to be suboptimal.</p>
<p>If you are coming from plumber then this document may serve as a starting ground for recalibrating yourself to the ways of plumber2, as well as an aid when updating old plumber APIs to plumber2.</p>
<h2 id="pr_-to-api_"><code>pr_*()</code> to <code>api_*()</code></h2>
<p>One of the first changes you may recognise is that the functional interface has gotten a prefix change. This has been done, partly to avoid any namespace conflicts with plumber, partly to avoid users assuming the functions worked 100% equivalently, and partly because the <code>pr</code> prefix was not very descriptive. It is an acronym for Plumber Route, but an API is much more than its router (especially in plumber2) so having that as a general prefix doesn’t make sense.</p>
<p>The new prefix, <code>api</code>, is a well-known acronym (Application Programming Interface) with a single meaning that fits what plumber2 is meant to help creates. The plumber object you are creating is also referred to as a Plumber API to further underscore this.</p>
<p>The functional interface does not match 1-to-1 if you substitute the prefix so you shouldn’t expect a find-replace to be all that is needed.</p>
<h2 id="only-path-arguments-are-passed-as-named-arguments-to-your-handler">Only path arguments are passed as named arguments to your handler</h2>
<p>In plumber, both path argument, query parameters, and potentially body parts where used as named arguments when calling your handler function. This presented multiple problems, first and foremost which one would win if there were name clashes between them. It also meant that the query string was always parsed even if your handler didn’t use it for anything, adding unnecessary overhead.</p>
<p>In plumber2 we avoid the confusion by only supplying path arguments to the handler function as named arguments. Query parameters and request body is passed to the function as the <code>query</code> and <code>body</code> argument respectively. Further, they are passed in a way that means that if your function doesn’t touch them they will never be parsed.</p>
<p>This change means that if your handler contains arguments that is meant to come from the query string or request body you should update it to accept a <code>query</code> and/or <code>body</code> argument and grab what you need from there.</p>
<h2 id="no-more-filter-and-preempt">No more filter and preempt</h2>
<p>Filters and preempt has been removed completely from plumber2. They existed mainly because plumber had no other way of letting users perform multiple chained operations on requests. In plumber2 it is possible to have as many routes as you want, each one being tried in sequence. Further it is possible to have a routes that are called before the request has been completely recieved. These can be used to inspect the headers of the request and reject it before it even enters your main router chain.</p>
<p>The functionality from the default filters in plumber has been moved. body, query, and cookie parsing is now handled by reqres in a fully automated way. The shared-secret filter is automatically created as a handler on the header route if a shared secret is found in the options.</p>
<h2 id="forward-replaced-by-next-and-break"><code>forward</code> replaced by <code>Next</code> and <code>Break</code></h2>
<p>Since filters are no more, <code>forward</code> which was a filter specific construct is also gone. However, since every handler might now only be one in a chain of handlers, we have added new ways to control the flow of request handling. Any handler is assumed to pass handling on to the next (if any) handler in the chain. You can make this explicit by returning <code>Next</code> from your handler, but this is not required. You’d often like to instead return an object to be assigned to the response body which you can do as well. Basically returning anything other than <code>Break</code> will allow the handling chain to continue its execution. However, returning <code>Break</code> will inform plumber2 that this handler specifically wants to return the response as it is <em>right now</em> with no further modification (except for serializing). This is useful in header route handlers to reject requests early on, but can also be used in the normal request handling if e.g. you know a resource has been moved and you want to return a redirect response immediately.</p>
<p>You might also want to use <code>Break</code> if your handler catches an error and need to abort. However, plumber2 offers a much better way to do this by utilising the <a href="https://reqres.data-imaginist.com/reference/abort_http_problem.html"><code>abort_*()</code></a> functions from reqres. Throwing such an exception will immediately stop the handling of the request, set the response according to the abort content and log the error.</p>
<h2 id="new-request-and-response-objects">New Request and Response objects</h2>
<p>Plumber provided its own objects for working with HTTP request and responses. In plumber2 we now uses the <a href="https://reqres.data-imaginist.com/reference/Request.html"><code>Request</code></a> and <a href="https://reqres.data-imaginist.com/reference/Response.html"><code>Response</code></a> objects from reqres. These are highly capable classes that has removed a lot of the internal logic from plumber2. They are responsible for content negotiation, cookies, headers, etc. and support encrypted session data storage like you are used to from plumber.</p>
<h2 id="new-plumber-object">New Plumber object</h2>
<p>The main class encapsulating your API has, unsurprisingly, also changed in plumber2. <a href="https://fiery.data-imaginist.com">Fiery</a> is now used as a backbone of plumber2 and the <code>Plumber</code> class is now a subclass of the powerful <a href="https://fiery.data-imaginist.com/reference/Fire.html"><code>Fire</code></a> class which offers many capabilities for advanced use, should you wish to level up your plumber API</p>
<h2 id="added-query-and-body-tags">Added <code>@query</code> and <code>@body</code> tags</h2>
<p>In plumber the <code>@param</code> tag was used to document both path parameters, query parameters and request body. In line with making the handler function arguments more explicit we also want to apply that to the documentation and so, you now document query and body with the explicit <code>@query</code> and <code>@body</code> tags. The syntax for these tags are the same as for <code>@param</code></p>





</body></html>